---
title: "Shrinkage verbs"
author: "Daniel Kaplan"
date: "2023-05-06"
categories: [reduction, ]
---

```{r include=FALSE}
library(math300)
source("../../_startup.R")
```

Much of the time when we use `mutate()`, we are generating a new variable out of those already in the data frame. All sorts of mathematical and character transformations are available. For instance, the `KidsFeet` data frame records the length and width of 39 third- and fourth-grade children. [We will use a short subsample of the `KidsFeet` data for the purposes of demonstration.]{.aside} If we would like to work with the aspect ratio of the feet, which is length divided by width, `mutate()` will do the work for us.

```{r results="hide"}
KidsFeet |> 
  mutate(aspect = length / width)
```

```{r echo=FALSE}
set.seed(104)
Small <- KidsFeet |> select(sex, length, width) |> sample(5) |> select(-orig.id)
rownames(Small) <- NULL
```


```{r echo=FALSE, digits=3}
#| label: tbl-aspect-ratio
#| tbl-cap-location: margin
#| tbl-cap: "An example of `mutate()` with a transformation that works on each row individually."
Small |>  mutate(aspect = length/width)
```


This Lesson introduces transformations of a different kind, some of which you are already familiar with. We will call these "**shrinkage**" transformations because, rather than dealing with the data frame rows one at a time, these transformations work on the rows collectively.

Perhaps the simplest shrinkage transformation is averaging. An average, of course, combines (shrinks) many numerical values to give a single representative one. Two examples of averages are the **mean** and **median**.  When `mutate()` encounters a shrinkage transformation of this sort, it inserts the same value for all of the rows. You can think of mean or median as shrinking the range of values of its argument into a single number.


```{r results="hide"}
KidsFeet |> mutate(mean(length))
```


```{r echo=FALSE, digits=3}
#| tbl-cap-location: margin
#| label: tbl-mean-len1
#| tbl-cap: "Some shrinkage operators insert the same value for each row, reflecting the collective properties of all rows. "
Small |> mutate(mean(length)) 
```


Usually, we prefer to give column names that are short and have no special characters. To accomplish this, use *named arguments* to `mutate()`. The names are up to you. Here's an example:

```{r results="hide"}
KidsFeet |> mutate(mlen = mean(length))
```

```{r echo=FALSE, digits=3}
#| tbl-cap-location: margin
#| label: tbl-mean-len2
#| tbl-cap: "Imposing a more concise column name using a named-argument syntax."
Small |> select(-width) |> mutate(mlen = mean(length)) 
```

::: {.callout-note}
## Rank of a variable

Two interesting shrinkage transforms with important uses in statistics are `rank()` and `percent_rank()`. These tell where each row would stand if the values had been sorted in ascending order:

```{r results="hide"}
KidsFeet |> mutate(rank=rank(length), percentile=100*percent_rank(length))
```

```{r echo=FALSE, digits=3}
#| tbl-cap-location: margin
#| label: tbl-mean-rank
#| tbl-cap: "`rank()` and percent_rank()` are very much the same, with `percent_rank()` scaling the results to fit into the range 0 to 1."
Small |> select(-width) |> mutate(rank=rank(length), percentile=100*percent_rank(length)) 
```

Unlike `mean()`, the `rank()` transformations do not insert the same value in each row. Still, the output values depend collectively on the values in the input. This is completely characteristic of a shrinkage transformation.
:::

## Groupwise operations

The `group_by()` wrangling verb sets up `mutate()` to use shrinkage transformations separately for each group. For instance:

```{r results="hide"}
KidsFeet |> 
  group_by(sex) |>
  mutate(rank=rank(length))
```

```{r echo=FALSE, digits=3}
#| label: tbl-grouped-rank
#| tbl-cap-location: margin
#| tbl-cap: "`group_by()` sets up `mutate()` to calulate shrinkage values group-by-group."
Small |> select(-width) |> 
  group_by(sex) |> mutate(rank=rank(length)) |> ungroup()
```

Rank 1 appears twice in @tbl-grouped-rank, once for the girls and once for the both. Within both groups, rank 1 is assigned to the row with the smallest `length`.

In the [next Lesson](../Prelude-to-modeling/) we will work extensively with groupwise means as a way of summarizing the similarities within a group and the differences between groups.

